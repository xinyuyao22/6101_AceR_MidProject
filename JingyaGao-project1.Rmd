---
title: "project1"
author: "Jingya Gao"
date: "10/12/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
loadPkg("corrplot")
loadPkg("ggplot2")
loadPkg("tidyverse")
loadPkg("ggpubr")
```

```{r basic}
cardio <- read.csv("cardio_train.csv", sep = ";")
cardio$age <- (cardio$age)/365
cardio$age <- round(cardio$age)
cardio$bmi <- cardio$weight/((cardio$height/100)^2)
```

```{r outlierKD_def, include=FALSE}
# modified to allow prompt-free run-through
outlierKD <- function(dt, var, rmv=NULL) { 
     var_name <- eval(substitute(var),eval(dt))
     na1 <- sum(is.na(var_name))
     m1 <- mean(var_name, na.rm = T)
     sd1 <- sd(var_name,na.rm = T)
     par(mfrow=c(2, 2), oma=c(0,0,3,0))
     boxplot(var_name, main="With outliers")
     hist(var_name, main="With outliers", xlab=NA, ylab=NA)
     outlier <- boxplot.stats(var_name)$out
     mo <- mean(outlier)
     var_name <- ifelse(var_name %in% outlier, NA, var_name)
     boxplot(var_name, main="Without outliers")
     hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
     title("Outlier Check", outer=TRUE)
     na2 <- sum(is.na(var_name))
     cat("Outliers identified:", na2 - na1, "n")
     cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "n")
     cat("Mean of the outliers:", round(mo, 2), "n")
     m2 <- mean(var_name, na.rm = T)
     cat("Mean without removing outliers:", round(m1, 2), "n")
     cat("Mean if we remove outliers:", round(m2, 2), "n")
     #
     if(is.null(rmv)) { 
       response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ") 
     } else {
       if (rmv=='y'|rmv=='yes'|rmv=='Y'|rmv=='Yes'|rmv=='YES'|rmv==TRUE ) { response = 'y' } else { response = 'n' }
     }
     #
     if(response == "y" | response == "yes"){
          dt[as.character(substitute(var))] <- invisible(var_name)
          assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
          cat("Outliers successfully removed", "n")
          return(invisible(dt))
     } else{
          cat("Nothing changed", "n")
          return(invisible(var_name))
     }
}
```


```{r, include=FALSE}
cardio1 <- cardio[which(cardio$age > 35), ]
outlierKD(cardio1, height, 'y')
outlierKD(cardio1, weight, 'y')
outlierKD(cardio1, ap_hi, 'y')
outlierKD(cardio1, ap_lo, 'y')
```


```{r groupbyAge}
labs <- c(paste(seq(35, 65, by = 10), seq(44, 74, by =10 ), sep = "-"))
cardio1$ageGroup <- cut(cardio1$age, breaks = c(seq(35, 74, by = 10), Inf), labels = labs, right = FALSE)
```

### Chapter 6: Meacurement at Predicting Cardiovascular Disease
Being overweight or obese substantially increases your risk of developing cardiovascular disease. However, researchers don’t always agree which method is best for quantifying whether an individual is “too” overweight. So, this section will analyze if the BMI is the best meacurement at predicting risk.

#### 6.1 SMART Question
Is BMI the best measurement at predicting risk in every individual? If not, is there another measurement to help to predict the risk of cardiovascular disease?

#### 6.2 Cardio in Different BMI Group
To find the adult weight classification, see which of these BMI ranges the weight falls into:
```{r groupbyBMI}
cardio1$bmiGroup <- cut(cardio1$bmi, breaks = c(0, 18.5, 25, 30, 35, 45, 50, Inf), labels = c("underWeight", "normalWeight", "overWeight", "obese", "severelyObese", "morbidlyObese", "superObese"), right = FALSE)
```

BMI  |   adult weight classification  |  
-------|-----|
[0, 18.5) kg/m^2  | underWeight | 
[18.5, 25) kg/m^2  | normalWeight | 
[25, 30) kg/m^2  | overWeight |
[30, 35) kg/m^2  | obese |
[35, 45) kg/m^2  | severelyObese |
[45, 50) kg/m^2  | morbidlyObese |
[50, Inf) kg/m^2  | superObese |

```{r bmi_cardio}
ggplot(data=cardio1, mapping=aes(x=bmiGroup,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='fill')+
scale_fill_manual(values=c('#E5E7E9','#E74C3C'))+
theme_minimal()+
labs(title="Proportion of cardio per bmiGroup",x="BMI Group", y = "proportion")+
theme(axis.text.x = element_text(angle=90, hjust=1)) 
```


The bar chart pressents the incidence of cardiovascular disease in groups of different BMI levels. From the figure we can see that before the severelyObese level, as the BMI parameter continues to increase, the incidence of cardiovascular disease gradually increases. When the BMI level exceeds severelyObese level, the morbidity rate tends to be stable and has a slow downward trend. 
However, BMI is not always accurate in every individual. It overestimates body fat in people with a lot of muscle mass and tends to underestimate it in elderly people. So, the idea of using waist circumference as a risk predictor stems from the fact comes up.

#### 6.3 Predicted Waist Circumference by BMI

Carrying excess body fat around your middle is more of a health risk than if weight is on your hips and thighs. In that case, waist circumference is a better estimate of visceral fat, the dangerous internal fat that coats the organs.

An initial model expressed the regression of WC on BMI in the following form:

WCi = b0 + b1BMIi + b2AGEi + b3BLACKi + b4HISPi + ei

where i indexes individuals, WCi is waist circumference for individual i, BMIi is body mass index, AGEi is current age (in years), BLACKi is an indicator for African-American, HISPi is an indicator for Hispanic ethnicity, and ei is the residual.

For women the pattern was better summarized by using one constant for age<35years and a separate intercept and slope for age≥35years. Thus, the model for women was

WCi = c0 + c1BMIi + c2I{AGEi ≥ 35} + c3AGEi × I{AGEi ≥ 35} + c4BLACKi + c5HISPi + ei

where I{B} is an indicator function: I{B} = 1 when B is true and 0 otherwise.

After the prediction, the sample of the data is as follows:
```{r predict_waist}
predicted_men_waist <- function(bmi, age){
    b0 = 22.61306
    b1BMI = 2.520738*(bmi)
    b2AGE = 0.1583812*(age)
    return (b0 + b1BMI + b2AGE)
}

predicted_women_waist <- function(bmi, age){
    c0 = 28.81919
    c1BMI = 2.218007*(bmi)
    age_35 = 1
    c2IAGE35 = -3.688953 * age_35
    IAGE35 = -0.6570163 * age_35
    c3AGEi = 0.125975*(age)
    return (c0 + c1BMI + c2IAGE35 + IAGE35 + c3AGEi)
}

predicted_waist <- function(gender, bmi, age){
    ifelse(gender == 2, predicted_men_waist(bmi, age), predicted_women_waist(bmi, age))
}

cardio1$predict_waist <- predicted_waist(cardio1$gender, cardio1$bmi, cardio1$age)

head(cardio1[c("gender", "bmi", "predict_waist")], 5)
```

#### 6.4 Cut Off Line and Obese

Studies have shown that a waist circumference of 95cm or more in men, and of 88cm or more in women, is associated with elevated cardiovascular risk. So, we use these parameters as cuf off line for each gender.

A Body Mass Index of 25kg/m^2 or more is defined as obese, which means the risk of having cardiovascular disease is higher. 

At the same time, two parameters are defined here: "safe area" and "warning area". When both waist circumference and BMI parameters are lower than the cut off line and obese parameters, the result is safe area, otherwise the result is warnning area.

The statistical results of cardiovascular disease after cut off and obese classification are as follows:
```{r bmi cut_off}
obesed <- function(bmi){
  ifelse(bmi < 25, "normal weight", "obese")
}
cardio1$obese <- obesed(cardio1$bmi)


cutOff_men <- function(predict_waist){
  ifelse(predict_waist > 95, "over cut off", "below cut off")
}
cutOff_women <- function(predict_waist){
  ifelse(predict_waist > 88, "over cut off", "below cut off")
}
cutOff <- function(gender, predict_waist){
  ifelse(gender == 2, cutOff_men(predict_waist), cutOff_women(predict_waist))
}
cardio1$cut_off <- cutOff(cardio1$gender, cardio1$predict_waist)


bmi_waist_men <- function(predict_waist, bmi){
  ifelse((predict_waist < 95) & (bmi < 25), "safe area", "warning area")
}
bmi_waist_women <- function(predict_waist, bmi){
  ifelse((predict_waist < 88) & (bmi < 25), "safe area", "warning area")
}
bmiWaist <- function(gender, predict_waist, bmi){
  ifelse(gender == 2, bmi_waist_men(predict_waist, bmi), bmi_waist_women(predict_waist, bmi))
}
cardio1$bmi_waist <- bmiWaist(cardio1$gender, cardio1$predict_waist, cardio1$bmi)
```

```{r list_gender_cutoff_cardio}
summary_combine <- cardio1 %>% 
  count(gender, obese, cut_off, bmi_waist, cardio)

knitr::kable(summary_combine)
```

#### 6.5 Cut Off Line, Obese, Cardiovascular Disease

```{r dif gender group}
cardio_women <- subset(cardio1, gender == 1)
cardio_men <- subset(cardio1, gender == 2)
```

* The bar plot below shows the relationship between obesity and cardiovascular disease morbidity in all genders, men and women.

```{r obese vs Cardio, fig.width = 18, fig.height = 6}
p0 <- ggplot(data=cardio1, mapping=aes(x=obese,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#EC7063'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Obese vs Cardio")

w0 <- ggplot(data=cardio_women, mapping=aes(x=obese,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#EC7063'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Women Obese vs Cardio")

m0 <- ggplot(data=cardio_men, mapping=aes(x=obese,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#EC7063'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Men Obese vs Cardio")

ggarrange(p0, w0, m0, ncol=3,nrow=1)
```
From the three obesity vs cardiovascular disease bar plots, the risk of having cardiovascular disease in all genders is 15% if they have normal weight, and 34.9% if they are obese. In only women section, the risk of having cardiovascular disease is 14.3% if she has normal weight, and 35.3% if she is obese. In only men section, the risk of having cardiovascular disease is 16.4% if he has normal weight, and 34.1% if he is obese.

* The bar plot below shows the relationship between cut off line and cardiovascular disease morbidity in all genders, men and women.

```{r cut-off vs Cardio, fig.width = 18, fig.height = 6}
p1 <- ggplot(data=cardio1, mapping=aes(x=cut_off,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#5DADE2'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Waist Cut Off vs Cardio")

w1 <- ggplot(data=cardio_women, mapping=aes(x=cut_off,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#5DADE2'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Women Waist Cut Off vs Cardio")

m1 <- ggplot(data=cardio_men, mapping=aes(x=cut_off,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#5DADE2'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Men Waist Cut Off vs Cardio")

ggarrange(p1,w1, m1, ncol=3,nrow=1)
```
From the three cut off line vs cardiovascular disease bar plots, the risk of having cardiovascular disease in all genders is 16.7% if the waist circumference is below cut off line, and 33.2% if the waist circumference is over cut off line. In only women section, the risk of having cardiovascular disease is 16.2% if her waist circumference is below cut off line, and 33.5% if her waist circumference is over cut off line. In only men section, the risk of having cardiovascular disease is 17.7% if his waist circumference is below cut off line, and 32.8% if his waist circumference is over cut off line.

* The bar plot below shows the relationship between safe/warning area and cardiovascular disease morbidity in all genders, men and women.

```{r bmi waist vs Cardio, fig.width = 18, fig.height = 6}
p2 <- ggplot(data=cardio1, mapping=aes(x=bmi_waist,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#A569BD'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="BMI + Waist Cut Off vs Cardio")

w2 <- ggplot(data=cardio_women, mapping=aes(x=bmi_waist,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#A569BD'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Women bmi_waist vs Cardio")

m2 <- ggplot(data=cardio_men, mapping=aes(x=bmi_waist,fill=factor(cardio)))+
geom_bar(stat="count",width=0.5,position='dodge')+
scale_fill_manual(values=c('#E5E7E9','#A569BD'))+
geom_text(stat='count',aes(label=scales::percent(..count../sum(..count..))), color="black", size=3.5,position=position_dodge(0.5), vjust=1.5)+
theme_minimal()+
labs(title="Men bmi_waist vs Cardio")

ggarrange(p2,w2, m2, ncol=3,nrow=1)
```

From the three safe/warning area vs cardiovascular disease bar plots, the risk of having cardiovascular disease in all genders is 14.9% if he/she is in safe area, and 35% if he/she is in warning area. In only women section, the risk of having cardiovascular disease is 14.3% if she is in safe area, and 35.4% if she is in warning area. In only men section, the risk of having cardiovascular disease is 16% if he is in safe area, and 34.5% if he is in warning area.


